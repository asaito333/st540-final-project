install.packages("dbarts")
library(dbarts)
set.seed(12)
res_chars <- read.csv('res_chars.csv')
setwd("C:/Users/asaito2/GitHub/st540-final-project")
set.seed(12)
res_chars <- read.csv('res_chars.csv')
QI_df <- read.csv('QI.csv')
QO_df <- read.csv('QO.csv')
# Transfer data to merge
QI <- as.matrix(sapply(QI_df[, -1], as.numeric))
QO <- as.matrix(sapply(QO_df[, -1], as.numeric))
rownames(QO) <- QO_df[, 1]
rownames(QI) <- QI_df[, 1]
res_chars$ReservoirID <- as.character(res_chars$X)
# Convert outflow matrix to a long tibble to merge
df_out <- as_tibble(QO,  .name_repair = "minimal") %>%
mutate(ReservoirID = rownames(QO)) %>%
pivot_longer(
cols      = -ReservoirID,
names_to  = "Year",
values_to = "Outflow"
)
library(dplyr)
# install.packages('tidyr')
library(tidyr)
df_out <- as_tibble(QO,  .name_repair = "minimal") %>%
mutate(ReservoirID = rownames(QO)) %>%
pivot_longer(
cols      = -ReservoirID,
names_to  = "Year",
values_to = "Outflow"
)
# Convert inflow matrix to a long tibble to merge
df_in  <- as_tibble(QI,  .name_repair = "minimal") %>%
mutate(ReservoirID = rownames(QI)) %>%
pivot_longer(
cols      = -ReservoirID,
names_to  = "Year",
values_to = "Inflow"
)
# Merge them outflow, inflow, and res-char variables
df <- df_out %>%
left_join(df_in, by = c("ReservoirID","Year")) %>%
# pick only the 5 cols you need from res_char_df:
left_join(
res_chars %>% select(ReservoirID, Capacity, DOR, Depth, CatchArea, AvgRelease),
by = "ReservoirID"
)
df$Year <- as.numeric(sub("^X", "", df$Year))
# Create X and Y
Y <- df$Outflow
X <- model.matrix(
~ Inflow + Capacity + Depth + DOR + CatchArea + AvgRelease,
data = df)
# train-test-split
test_idx  <- sample(nrow(df), size = 0.2 * nrow(df))
train_idx <- setdiff(seq_len(nrow(df)), test_idx)
X_train   <- X[train_idx, ]
Y_train   <- Y[train_idx]
X_test    <- X[test_idx, ]
Y_test    <- Y[test_idx]
fit2 <- bart(
x.train = X_train,
y.train = Y_train,
x.test  = X_test,
ntree   = 5,
verbose = FALSE
)
yhat_mean <- bart_fit$yhat.test.mean
yhat_mean <- fit2$yhat.test.mean
yhat_sd <- apply(yhat_samples, 2, sd)
yhat_samples <- fit2$yhat.test
yhat_sd <- apply(yhat_samples, 2, sd)
results <- data.frame(
Observed   = Y_test,
Predicted  = yhat_mean,
Uncertainty = yhat_sd
)
ss_res <- sum((Y_test - yhat_mean)^2)
ss_tot <- sum((Y_test - mean(Y_test))^2)
R2     <- 1 - ss_res/ss_tot
cat("R-squared:", round(R2, 4), "\n")
plot(
Y_test,
yhat_mean,
xlab = "Observed Outflow (Y_test)",
ylab = "Predicted Outflow (yhat_mean)",
main = "Observed vs. Predicted Outflow",
pch  = 16
)
abline(0, 1)  # 45° line for reference
plot(
Y_test,
yhat_mean,
xlab = "Observed Outflow (Y_test)",
ylab = "Predicted Outflow (yhat_mean)",
main = "Observed vs. Predicted Outflow",
pch  = 16
)
abline(0, 1, lty = 3)  # 45° line for reference
